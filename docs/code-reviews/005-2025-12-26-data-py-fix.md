# Fix Report: data.py Dataset Reporting and Loading

**Date:** 2025-12-26
**Context Commit:** `9137483`
**Component:** `moe-emergence/data.py`

---

## Issues Fixed

1. **Balanced token counts were incorrect after truncation**
   - Token counts were computed before balancing and never updated.
   - Reported per-domain tokens could be larger than the actual balanced dataset.

2. **Math dataset fallback could silently underfill the target**
   - A try/except allowed GSM8K-only math data even when the target size
     required MATH to reach the requested MB.

3. **Dataset metadata logging was incomplete**
   - Info dicts omitted dataset builder/version metadata needed for
     reproducibility checks.

---

## Root Cause

- Token counts were stored before balancing and not recalculated after slicing.
- Defensive error handling masked missing MATH loads.
- Metadata was assembled manually without using dataset info.

---

## Fix

- Recompute token counts when `--balance-tokens` is applied.
- Require MATH when GSM8K does not reach the size target (no silent fallback).
- Add dataset metadata helper to log builder name and version/config.

---

## Before/After

**Before:**
```python
if balance_tokens:
    ...
    self.block_counts = {
        "code": min_blocks,
        "math": min_blocks,
        "prose": min_blocks,
    }
```

**After:**
```python
if balance_tokens:
    ...
    self.block_counts = {
        "code": min_blocks,
        "math": min_blocks,
        "prose": min_blocks,
    }
    self.token_counts = {
        "code": min_blocks * block_size,
        "math": min_blocks * block_size,
        "prose": min_blocks * block_size,
    }
```

---

## Verification

- Manual review of `moe-emergence/data.py` logic and output paths.
- No runtime test executed for this fix.

---

## Notes

- For small `--size-mb` values, GSM8K can satisfy the target before MATH loads.
  In that case, MATH is not required.
